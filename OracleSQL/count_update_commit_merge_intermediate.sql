
--step 1 row count
SELECT COUNT (*) FROM DF_TBC_SPEND_FINAL
WHERE EXCHANGE_RATE_CURRENCY IS NULL
AND SUPPLIER_COUNTRY IS NULL;

SELECT COUNT(*) FROM DF_TBC_SPEND_FINAL
WHERE SOURCE_SYSTEM = 'SAP'
AND SUPPLIER_COUNTRY IS NULL;

--step 1 update

-- First, updating rows where both EXCHANGE_RATE_CURRENCY and SUPPLIER_COUNTRY are null
UPDATE DF_TBC_SPEND_FINAL
SET EXCHANGE_RATE_CURRENCY = 'USD',
    SUPPLIER_COUNTRY = 'UNITED STATES'
WHERE EXCHANGE_RATE_CURRENCY IS NULL 
AND SUPPLIER_COUNTRY IS NULL;

-- Then, updating rows where SOURCE_SYSTEM is "SAP" and SUPPLIER_COUNTRY is null
UPDATE DF_TBC_SPEND_FINAL
SET SUPPLIER_COUNTRY = 'UNITED STATES'
WHERE SOURCE_SYSTEM = 'SAP' 
AND SUPPLIER_COUNTRY IS NULL;

-- To commit the changes to the database
COMMIT;

--step 2 row count

--row count for concur data NOV22-MAR23
SELECT COUNT (*) FROM DF_TBC_SPEND_FINAL
WHERE FILE_NAME IN
(
    'TBC_CONCUR_FY22-NOV',
    'TBC_CONCUR_FY22-DEC',
    'TBC_CONCUR_FY22-JAN',
    'TBC_CONCUR_FY22-FEB',
    'TBC_CONCUR_FY22-MAR'
);

--make sure all concur data NOV22-MAR23 is being matched
SELECT COUNT(*)
FROM DF_TBC_SPEND_FINAL FINAL
INNER JOIN DF_TBC_UPDATE_TABLE SOURCE
ON (FINAL.BUYER_ID = SOURCE.BUYER_ID 
    AND FINAL.EXPENSE_TYPE = SOURCE.EXPENSE_TYPE
    AND FINAL.TRANSACTION_DATE = SOURCE.TRANSACTION_DATE
    AND FINAL.TOTAL_SPEND_USD = SOURCE.TOTAL_SPEND_USD
    AND FINAL.ASSETID = SOURCE.ASSETID);
    

--step 2 update
MERGE INTO DF_TBC_SPEND_FINAL FINAL 
USING (
    SELECT 
        BUYER_ID, EXPENSE_TYPE, TRANSACTION_DATE, TOTAL_SPEND_USD, ASSETID, SUPPLIER_COUNTRY
    FROM 
        DF_TBC_UPDATE_TABLE
) SOURCE
ON (FINAL.BUYER_ID = SOURCE.BUYER_ID 
    AND FINAL.EXPENSE_TYPE = SOURCE.EXPENSE_TYPE
    AND FINAL.TRANSACTION_DATE = SOURCE.TRANSACTION_DATE
    AND FINAL.TOTAL_SPEND_USD = SOURCE.TOTAL_SPEND_USD
    AND FINAL.ASSETID = SOURCE.ASSETID)
WHEN MATCHED THEN 
    UPDATE SET FINAL.SUPPLIER_COUNTRY = SOURCE.SUPPLIER_COUNTRY;
    
SELECT COUNT (*) FROM DF_TBC_SPEND_FINAL
WHERE SUPPLIER_COUNTRY IS NULL;
